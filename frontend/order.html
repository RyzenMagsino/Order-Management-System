<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="/frontend/assets/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <title>Home</title>
    <style>
        .table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .table thead th {
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #dee2e6;
        }

        .table tbody tr {
            border-bottom: 1px solid #f8f9fa;
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
            transform: scale(1.001);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .wrapper {
            background: white;
            border: 1px solid #e9ecef;
        }

        .badge {
            padding: 0.5em 1em;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        /* Status badge styles */
        .badge.bg-warning {
            background-color: #fff3cd !important;
            color: #856404 !important;
        }

        .badge.bg-success {
            background-color: #d4edda !important;
            color: #155724 !important;
        }

        .badge.bg-danger {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }

        /* Action buttons styling */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.2rem;
            margin: 0 2px;
            transition: all 0.2s;
        }

        .btn-sm:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row flex-nowrap">
            <!-- Sidebar -->
            <div class="sidebar col-auto min-vh-100 d-flex flex-column justify-content-between">
                <div class=" p-2">
                    <a href="" class="d-flex text-decoration-none mt-1 align-items-center text-white">
                        <span>TINDAHAN NI RYZEN</span>
                    </a>
                    <ul class="nav nav-pills flex-column mt-4">
                        <li class="nav-item py-2 py-sm-0">
                            <a href="index.html" class="nav-link text-white">
                                <i class="fa fa-gauge"></i><span class="fs-5 ms-3 d-none d-sm-inline">Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-item py-2 py-sm-0">
                            <a href="order.html" class="nav-link active text-white">
                                <i class="fa fa-clipboard" style="color: #ffffff;"></i><span class="fs-5 ms-3 d-none d-sm-inline">Orders</span>
                            </a>
                        </li>
                        <li class="nav-item py-2 py-sm-0">
                            <a href="product.html" class="nav-link text-white">
                                <i class="fa fa-table-list" style="color: #ffffff;"></i><span class="fs-5 ms-3 d-none d-sm-inline">Products</span>
                            </a>
                        </li>
                        <li class="nav-item py-2 py-sm-0">
                            <a href="transaction.html" class="nav-link text-white">
                                <i class="fa fa-money-check" style="color: #ffffff;"></i><span class="fs-5 ms-3 d-none d-sm-inline">Transaction</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="dropdown open p-3">
                    <button class="btn border-none dropdown-toggle text-white" type="button" id="triggerId" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa-solid fa-user" style="color: #ffffff;"></i><span class="ms-2">Admin</span>
                    </button>
                    <div class="dropdown-menu" aria-labelledby="triggerId">
                        <button class="dropdown-item" href="#">Setting</button>
                        <button class="dropdown-item" href="#">Profile</button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <section class="container col-auto col-sm-6 col-md-10 g-2 py-5">
                <!-- Button to add order -->
                <button class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#addOrderModal">Add Order</button>

                <!-- Order Table -->
                <div class="table-responsive mt-4 p-4 wrapper rounded-3 shadow-sm">
                    <table class="table table-hover align-middle mb-0 bg-white">
                        <thead>
                            <tr class="text-center" style="background-color: #f8f9fa;">
                                <th class="py-3">OrderId</th>
                                <th class="py-3">Customer Name</th>
                                <th class="py-3">Date</th>
                                <th class="py-3">Time</th>
                                <th class="py-3">Payment Method</th>
                                <th class="py-3">Order Details</th>
                                <th class="py-3">Status</th>
                                <th class="py-3">Action</th>
                            </tr>
                        </thead>
                        <tbody class="text-center" id="userDetails">
                            <!-- Orders will be populated here dynamically -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div class="modal fade" id="addOrderModal" tabindex="-1" aria-labelledby="addOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #1a1a1a; color: white;">
                    <h5 class="modal-title" id="addOrderModalLabel">
                        <i class="fa fa-plus-circle me-2"></i>Add New Order
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="addOrderForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerName" class="form-label fw-bold">
                                    <i class="fa fa-user me-2"></i>Customer Name
                                </label>
                                <input type="text" class="form-control shadow-sm" id="customerName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="contactNumber" class="form-label fw-bold">
                                    <i class="fa fa-phone me-2"></i>Contact Number
                                </label>
                                <input type="text" class="form-control shadow-sm" id="contactNumber" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="deliveryAddress" class="form-label fw-bold">
                                <i class="fa fa-location-dot me-2"></i>Delivery Address
                            </label>
                            <input type="text" class="form-control shadow-sm" id="deliveryAddress" required>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fa fa-cart-shopping me-2"></i>Select Products
                            </label>
                            <div class="row g-3" id="productCheckboxContainer">
                                <!-- Products will be populated here dynamically -->
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label fw-bold">
                                <i class="fa fa-note-sticky me-2"></i>Notes
                            </label>
                            <textarea class="form-control shadow-sm" id="notes" rows="2"></textarea>
                        </div>

                        <div class="mb-4">
                            <label for="paymentMethod" class="form-label fw-bold">
                                <i class="fa fa-credit-card me-2"></i>Payment Method
                            </label>
                            <select class="form-select shadow-sm" id="paymentMethod" required>
                                <option value="" selected disabled>Select payment method</option>
                                <option value="Cash">Cash</option>
                                <option value="Gcash">Gcash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>

                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-save me-2"></i>Save Order
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title" id="editOrderModalLabel">Edit Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrderForm">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label">Customer Name</label>
                            <input type="text" class="form-control" id="editCustomerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDeliveryAddress" class="form-label">Delivery Address</label>
                            <input type="text" class="form-control" id="editDeliveryAddress" required>
                        </div>
                        <div class="mb-3">
                            <label for="editContactNumber" class="form-label">Contact Number</label>
                            <input type="text" class="form-control" id="editContactNumber" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProductSelect" class="form-label">Select Products</label>
                            <div id="editProductSelect">
                                <label><input type="checkbox" class="product-checkbox" value="Adobowow"> Adobowow</label><br>
                                <label><input type="checkbox" class="product-checkbox" value="Sinugnog"> Sinugnog</label><br>
                                <label><input type="checkbox" class="product-checkbox" value="Kalebayor"> Kalebayor</label><br>
                                <label><input type="checkbox" class="product-checkbox" value="Sinalsale"> Sinalsale</label><br>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editNotes" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editPaymentMethod" class="form-label">Payment Method</label>
                            <select class="form-control" id="editPaymentMethod" required>
                                <option value="Cash">Cash</option>
                                <option value="Gcash">Gcash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-warning">Update Order</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- View Order Details Modal -->
    <div class="modal fade" id="viewOrderDetailsModal" tabindex="-1" aria-labelledby="viewOrderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #1a1a1a; color: white;">
                    <h5 class="modal-title" id="viewOrderDetailsModalLabel">
                        <i class="fa fa-info-circle me-2"></i>Order Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6 class="fw-bold">Products:</h6>
                        <p id="viewOrderProducts"></p>
                    </div>
                    <div class="mb-3">
                        <h6 class="fw-bold">Notes:</h6>
                        <p id="viewOrderNotes"></p>
                    </div>
                    <div class="mb-3">
                        <h6 class="fw-bold">Delivery Address:</h6>
                        <p id="viewDeliveryAddress"></p>
                    </div>
                    <div class="mb-3">
                        <h6 class="fw-bold">Contact Number:</h6>
                        <p id="viewContactNumber"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
let orderIdCounter = 1; // Keeps track of order IDs
let editingOrderIndex = null; // Tracks the index of the order being edited

// Add this function before the loadOrders function
function viewOrderDetails(orderId, products, notes, deliveryAddress, contactNumber) {
    document.getElementById('viewOrderProducts').textContent = products;
    document.getElementById('viewOrderNotes').textContent = notes || 'No notes provided';
    document.getElementById('viewDeliveryAddress').textContent = deliveryAddress;
    document.getElementById('viewContactNumber').textContent = contactNumber;
    
    const modal = new bootstrap.Modal(document.getElementById('viewOrderDetailsModal'));
    modal.show();
}

// Function to load orders from the API and display them
async function loadOrders() {
    try {
        const response = await fetch('http://localhost:4000/api/orders');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const orders = await response.json();
        const userDetailsTable = document.getElementById('userDetails');
        userDetailsTable.innerHTML = ''; // Clear existing rows

        orders.forEach(order => {
            // Safely format the order details (products)
            const orderDetails = (order.orderDetails || [])
                .map(detail => {
                    // Safely access product name with fallback
                    const productName = detail.product ? detail.product.productName : 'Unknown Product';
                    return productName;
                })
                .filter(name => name) // Remove any undefined/null values
                .join(', ');

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${order._id}</td>
                <td>${order.customerName || 'N/A'}</td>
                <td>${order.orderDate || 'N/A'}</td>
                <td>${order.orderTime || 'N/A'}</td> 
                <td>${order.paymentMethod || 'N/A'}</td>
                <td>
                    <a href="#" class="text-primary text-decoration-none" 
                       onclick="viewOrderDetails('${order._id}', \`${orderDetails}\`, \`${order.notes || ''}\`, \`${order.deliveryAddress || 'N/A'}\`, \`${order.contactNumber || 'N/A'}\`)">
                        ${orderDetails || 'No products'}
                    </a>
                </td>
                <td><span class="badge ${getStatusBadgeClass(order.status)}">${order.status || 'Pending'}</span></td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editOrder('${order._id}')">
                        <i class="fa fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order._id}')">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            `;
            userDetailsTable.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading orders:', error);
        const userDetailsTable = document.getElementById('userDetails');
        userDetailsTable.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-danger">
                    Failed to load orders. Please try again later.
                    Error: ${error.message}
                </td>
            </tr>
        `;
    }
}

// Helper function to get the appropriate badge class based on status
function getStatusBadgeClass(status) {
    if (!status) return 'bg-secondary'; // Default case for null/undefined status
    
    switch (status.toLowerCase()) {
        case 'pending':
            return 'bg-warning text-dark';
        case 'completed':
            return 'bg-success';
        case 'cancelled':
            return 'bg-danger';
        default:
            return 'bg-secondary';
    }
}

// Update the Add Order form submission handler
document.getElementById('addOrderForm').addEventListener('submit', async function (event) {
    event.preventDefault();

    try {
        const customerName = document.getElementById('customerName').value;
        const deliveryAddress = document.getElementById('deliveryAddress').value;
        const contactNumber = document.getElementById('contactNumber').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const notes = document.getElementById('notes').value;

        // Get selected products with their MongoDB IDs
        const selectedProducts = Array.from(document.querySelectorAll('.product-checkbox:checked'))
            .map(checkbox => ({
                productId: checkbox.value,  // This will now be the MongoDB _id
                productName: checkbox.dataset.name
            }));

    if (selectedProducts.length === 0) {
        alert("Please select at least one product.");
        return;
    }

        const orderData = {
            customerName,
            deliveryAddress,
            contactNumber,
            paymentMethod,
            products: selectedProducts.map(p => p.productId), // Send only the MongoDB IDs
            notes,
            orderDate: new Date().toISOString().split('T')[0],
            orderTime: new Date().toTimeString().split(' ')[0],
            status: 'Pending'
        };

        console.log('Sending order data:', orderData); // Debug log

        const response = await fetch('http://localhost:4000/api/orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
        });

        const responseData = await response.json();
        
        if (!response.ok) {
            throw new Error(`Server Error: ${responseData.message || 'Unknown error'}`);
        }

        // Success handling
        const addModal = bootstrap.Modal.getInstance(document.getElementById('addOrderModal'));
        addModal.hide();
        this.reset();
        
        // Call loadOrders to refresh the table
        await loadOrders();
        
        Swal.fire({
            icon: 'success',
            title: 'Success',
            text: 'Order added successfully!'
        });

    } catch (error) {
        console.error('Full error details:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error Adding Order',
            text: error.message
        });
    }
});

// Update the loadProducts function
async function loadProducts() {
    try {
        const response = await fetch('http://localhost:4000/api/products');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const products = await response.json();
        
        const container = document.getElementById('productCheckboxContainer');
        container.innerHTML = '';
        
        products.forEach((product, index) => {
            if (index % 2 === 0) {
                container.innerHTML += `<div class="col-md-6">`;
            }
            
            const productHtml = `
                <div class="form-check custom-checkbox">
                    <input type="checkbox" class="form-check-input product-checkbox" 
                           value="${product._id}" 
                           data-name="${product.productName}"
                           id="product_${product._id}">
                    <label class="form-check-label" for="product_${product._id}">
                        ${product.productName} - $${product.price}
                    </label>
                </div>
            `;
            
            container.lastElementChild.innerHTML += productHtml;
            
            if (index % 2 === 1 || index === products.length - 1) {
                container.innerHTML += `</div>`;
            }
        });
    } catch (error) {
        console.error('Error loading products:', error);
        const container = document.getElementById('productCheckboxContainer');
        container.innerHTML = `
            <div class="alert alert-danger">
                Failed to load products. Please try again later.
                Error: ${error.message}
            </div>
        `;
    }
}

// Function to hndle Edit Ordera form submission
document.getElementById('editOrderForm').addEventListener('submit', function (event) {
    event.preventDefault();

    const customerName = document.getElementById('editCustomerName').value;
    const deliveryAddress = document.getElementById('editDeliveryAddress').value;
    const contactNumber = document.getElementById('editContactNumber').value;
    const paymentMethod = document.getElementById('editPaymentMethod').value;

    const selectedProducts = Array.from(document.querySelectorAll('.edit-product-checkbox:checked'))
        .map(checkbox => checkbox.value);

    if (selectedProducts.length === 0) {
        alert("Please select at least one product.");
        return;
    }

    const orderDetails = selectedProducts.join(", ");

    let orders = JSON.parse(localStorage.getItem("orders")) || [];
    orders[editingOrderIndex] = {
        ...orders[editingOrderIndex], // Keep existing orderId and other details
        customerName,
        deliveryAddress,
        contactNumber,
        paymentMethod,
        orderDetails
    };

    localStorage.setItem("orders", JSON.stringify(orders));
    loadOrders();

    const editModal = bootstrap.Modal.getInstance(document.getElementById('editOrderModal'));
    editModal.hide();
    document.getElementById('editOrderForm').reset();
    editingOrderIndex = null;
});

// Function to edit an order
function editOrder(index) {
    editingOrderIndex = index;
    const orders = JSON.parse(localStorage.getItem("orders")) || [];
    const order = orders[index];

    document.getElementById('editCustomerName').value = order.customerName;
    document.getElementById('editDeliveryAddress').value = order.deliveryAddress;
    document.getElementById('editContactNumber').value = order.contactNumber;
    document.getElementById('editPaymentMethod').value = order.paymentMethod;

    const productCheckboxes = document.querySelectorAll('.edit-product-checkbox');
    productCheckboxes.forEach(checkbox => {
        checkbox.checked = order.orderDetails.includes(checkbox.value);
    });

    const editModal = new bootstrap.Modal(document.getElementById('editOrderModal'));
    editModal.show();
}

// Update the deleteOrder function
async function deleteOrder(orderId) {
    try {
        // Show confirmation dialog
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        });

        if (result.isConfirmed) {
            const response = await fetch(`http://localhost:4000/api/orders/${orderId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('Failed to delete order');
            }

            await loadOrders(); // Refresh the table

            Swal.fire(
                'Deleted!',
                'Order has been deleted.',
                'success'
            );
        }
    } catch (error) {
        console.error('Error deleting order:', error);
        Swal.fire(
            'Error!',
            'Failed to delete order.',
            'error'
        );
    }
}

// Add new function to edit order status
async function editOrder(orderId) {
    try {
        const { value: status } = await Swal.fire({
            title: 'Update Order Status',
            input: 'select',
            inputOptions: {
                'Pending': 'Pending',
                'Completed': 'Completed',
                'Cancelled': 'Cancelled'
            },
            inputPlaceholder: 'Select status',
            showCancelButton: true,
            inputValidator: (value) => {
                if (!value) {
                    return 'Please select a status!';
                }
            }
        });

        if (status) {
            const response = await fetch(`http://localhost:4000/api/orders/${orderId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status })
            });

            if (!response.ok) {
                throw new Error('Failed to update status');
            }

            await loadOrders(); // Refresh the table

            Swal.fire(
                'Updated!',
                'Order status has been updated.',
                'success'
            );
        }
    } catch (error) {
        console.error('Error updating order status:', error);
        Swal.fire(
            'Error!',
            'Failed to update order status.',
            'error'
        );
    }
}

// Update the window.onload function to also load products
window.onload = function() {
    loadOrders();
    loadProducts();
};

// Also load products when the add order modal is shown
document.getElementById('addOrderModal').addEventListener('show.bs.modal', loadProducts);

// Load orders when page loads
document.addEventListener('DOMContentLoaded', loadOrders);

    </script>
</body>

</html>